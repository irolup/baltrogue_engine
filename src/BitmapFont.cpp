#include "BitmapFont.h"
#include <cmath>

BitmapFont::BitmapFont() {
    color[0] = color[1] = color[2] = 1.0f;
    color[3] = 1.0f;
}

BitmapFont::~BitmapFont() {
}

void BitmapFont::setColor(float r, float g, float b, float a) {
    color[0] = r; color[1] = g; color[2] = b; color[3] = a;
}

void BitmapFont::drawText(const std::string& text, float x, float y, float scale) {
    // Set color
    setColor(color[0], color[1], color[2], color[3]);

    // Convert screen coordinates to OpenGL coordinates (-1 to 1)
    float cursorX = (x - 960.0f) / 960.0f;
    float cursorY = (544.0f - y) / 544.0f;
    
    // Store initial X position for line breaks
    float initialX = cursorX;
    
    glDisable(GL_TEXTURE_2D);
    glEnable(GL_BLEND);
    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
    
    for(char c : text) {
        if(c == '\n') {
            cursorX = initialX;  // Reset to start of line
            cursorY -= (FONT_CHAR_HEIGHT * scale) / 544.0f;  // Move down (negative Y in OpenGL)
            continue;
        }
        
        drawCharacter(c, cursorX, cursorY, scale);
        
        // Advance cursor
        cursorX += (FONT_CHAR_WIDTH * scale) / 960.0f;
    }
    
    glEnable(GL_TEXTURE_2D);
    glDisable(GL_BLEND);
}

void BitmapFont::drawCharacter(char c, float& x, float y, float scale) {
    // Simple 8x12 bitmap font data for printable ASCII characters (32-126)
    // Each character is represented as a series of bits where 1 = pixel on, 0 = pixel off
    
    static const unsigned char fontData[95][12] = {
        // Space (32)
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        // ! (33)
        {0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00},
        // " (34)
        {0x6C, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        // # (35)
        {0x6C, 0x6C, 0xFE, 0x6C, 0x6C, 0xFE, 0x6C, 0x6C, 0x00, 0x00, 0x00, 0x00},
        // $ (36)
        {0x18, 0x18, 0x7C, 0xC6, 0xC0, 0x7C, 0x06, 0xC6, 0x7C, 0x18, 0x18, 0x00},
        // % (37)
        {0x00, 0x00, 0xC6, 0xCC, 0x18, 0x30, 0x60, 0xC6, 0x86, 0x00, 0x00, 0x00},
        // & (38)
        {0x38, 0x6C, 0x6C, 0x38, 0x76, 0xDC, 0xCC, 0x76, 0x00, 0x00, 0x00, 0x00},
        // ' (39)
        {0x18, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        // ( (40)
        {0x0C, 0x18, 0x30, 0x30, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00, 0x00, 0x00},
        // ) (41)
        {0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00, 0x00, 0x00},
        // * (42)
        {0x00, 0x00, 0x18, 0x18, 0x7E, 0x3C, 0x7E, 0x18, 0x18, 0x00, 0x00, 0x00},
        // + (43)
        {0x00, 0x00, 0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00},
        // , (44)
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x18, 0x30, 0x00, 0x00},
        // - (45)
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        // . (46)
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00},
        // / (47)
        {0x00, 0x00, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC0, 0x80, 0x00, 0x00, 0x00},
        // 0 (48)
        {0x7C, 0xC6, 0xC6, 0xCE, 0xDE, 0xF6, 0xE6, 0xC6, 0x7C, 0x00, 0x00, 0x00},
        // 1 (49)
        {0x18, 0x38, 0x78, 0x18, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00, 0x00, 0x00},
        // 2 (50)
        {0x7C, 0xC6, 0x06, 0x0C, 0x18, 0x30, 0x60, 0xC6, 0xFE, 0x00, 0x00, 0x00},
        // 3 (51)
        {0x7C, 0xC6, 0x06, 0x06, 0x3C, 0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00},
        // 4 (52)
        {0x0C, 0x1C, 0x3C, 0x6C, 0xCC, 0xFE, 0x0C, 0x0C, 0x1E, 0x00, 0x00, 0x00},
        // 5 (53)
        {0xFE, 0xC0, 0xC0, 0xFC, 0x06, 0x06, 0x06, 0xC6, 0x7C, 0x00, 0x00, 0x00},
        // 6 (54)
        {0x38, 0x60, 0xC0, 0xC0, 0xFC, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00},
        // 7 (55)
        {0xFE, 0xC6, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x30, 0x00, 0x00, 0x00},
        // 8 (56)
        {0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00},
        // 9 (57)
        {0x7C, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x06, 0x0C, 0x78, 0x00, 0x00, 0x00},
        // : (58)
        {0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00},
        // ; (59)
        {0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x30, 0x00, 0x00, 0x00},
        // < (60)
        {0x06, 0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x00, 0x00, 0x00},
        // = (61)
        {0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00},
        // > (62)
        {0x60, 0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x00, 0x00, 0x00},
        // ? (63)
        {0x7C, 0xC6, 0xC6, 0x0C, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00},
        // @ (64)
        {0x7C, 0xC6, 0xC6, 0xDE, 0xDE, 0xDE, 0xC0, 0xC0, 0x7C, 0x00, 0x00, 0x00},
        // A (65)
        {0x18, 0x3C, 0x66, 0xC3, 0xC3, 0xFF, 0xC3, 0xC3, 0xC3, 0x00, 0x00, 0x00},
        // B (66)
        {0xFC, 0x66, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x66, 0xFC, 0x00, 0x00, 0x00},
        // C (67)
        {0x3C, 0x66, 0xC3, 0xC0, 0xC0, 0xC0, 0xC3, 0x66, 0x3C, 0x00, 0x00, 0x00},
        // D (68)
        {0xF8, 0x6C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x6C, 0xF8, 0x00, 0x00, 0x00},
        // E (69)
        {0xFE, 0x62, 0x60, 0x64, 0x7C, 0x64, 0x60, 0x62, 0xFE, 0x00, 0x00, 0x00},
        // F (70)
        {0xFE, 0x62, 0x60, 0x64, 0x7C, 0x64, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00},
        // G (71)
        {0x3C, 0x66, 0xC3, 0xC0, 0xC0, 0xCE, 0xC3, 0x66, 0x3A, 0x00, 0x00, 0x00},
        // H (72)
        {0xC3, 0xC3, 0xC3, 0xC3, 0xFF, 0xC3, 0xC3, 0xC3, 0xC3, 0x00, 0x00, 0x00},
        // I (73)
        {0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00},
        // J (74)
        {0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0xCC, 0xCC, 0x78, 0x00, 0x00, 0x00},
        // K (75)
        {0xE6, 0x66, 0x6C, 0x78, 0x78, 0x6C, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00},
        // L (76)
        {0xF0, 0x60, 0x60, 0x60, 0x60, 0x60, 0x62, 0x66, 0xFE, 0x00, 0x00, 0x00},
        // M (77)
        {0xC3, 0xE7, 0xFF, 0xFF, 0xDB, 0xC3, 0xC3, 0xC3, 0xC3, 0x00, 0x00, 0x00},
        // N (78)
        {0xC3, 0xE3, 0xF3, 0xFF, 0xDF, 0xCF, 0xC7, 0xC3, 0xC3, 0x00, 0x00, 0x00},
        // O (79)
        {0x3C, 0x66, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0x66, 0x3C, 0x00, 0x00, 0x00},
        // P (80)
        {0xFC, 0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00},
        // Q (81)
        {0x3C, 0x66, 0xC3, 0xC3, 0xC3, 0xC3, 0xCF, 0xDE, 0x3C, 0x0E, 0x00, 0x00},
        // R (82)
        {0xFC, 0x66, 0x66, 0x66, 0x7C, 0x6C, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00},
        // S (83)
        {0x3C, 0x66, 0xC3, 0x60, 0x38, 0x0C, 0xC3, 0x66, 0x3C, 0x00, 0x00, 0x00},
        // T (84)
        {0xFF, 0xDB, 0x99, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00},
        // U (85)
        {0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0x66, 0x3C, 0x00, 0x00, 0x00},
        // V (86)
        {0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0xC3, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00},
        // W (87)
        {0xC3, 0xC3, 0xC3, 0xC3, 0xDB, 0xFF, 0xFF, 0xE7, 0xC3, 0x00, 0x00, 0x00},
        // X (88)
        {0xC3, 0xC3, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0xC3, 0xC3, 0x00, 0x00, 0x00},
        // Y (89)
        {0xC3, 0xC3, 0xC3, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00},
        // Z (90)
        {0xFF, 0xC3, 0x86, 0x0C, 0x18, 0x30, 0x61, 0xC3, 0xFF, 0x00, 0x00, 0x00},
        // [ (91)
        {0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00, 0x00, 0x00},
        // \ (92)
        {0x00, 0x00, 0x80, 0xC0, 0xE0, 0x70, 0x38, 0x1C, 0x0E, 0x06, 0x00, 0x00},
        // ] (93)
        {0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00, 0x00, 0x00},
        // ^ (94)
        {0x10, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        // _ (95)
        {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00},
        // ` (96)
        {0x30, 0x30, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
        // a (97)
        {0x00, 0x00, 0x00, 0x78, 0x0C, 0x7C, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00},
        // b (98)
        {0xE0, 0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x7C, 0x00, 0x00, 0x00},
        // c (99)
        {0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC0, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00},
        // d (100)
        {0x1C, 0x0C, 0x0C, 0x7C, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00},
        // e (101)
        {0x00, 0x00, 0x00, 0x7C, 0xC6, 0xFE, 0xC0, 0xC6, 0x7C, 0x00, 0x00, 0x00},
        // f (102)
        {0x38, 0x6C, 0x64, 0x60, 0xF0, 0x60, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00},
        // g (103)
        {0x00, 0x00, 0x76, 0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0xCC, 0x78, 0x00, 0x00},
        // h (104)
        {0xE0, 0x60, 0x60, 0x6C, 0x76, 0x66, 0x66, 0x66, 0xE6, 0x00, 0x00, 0x00},
        // i (105)
        {0x18, 0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00},
        // j (106)
        {0x06, 0x06, 0x00, 0x0E, 0x06, 0x06, 0x06, 0x06, 0x66, 0x66, 0x3C, 0x00},
        // k (107)
        {0xE0, 0x60, 0x60, 0x66, 0x6C, 0x78, 0x6C, 0x66, 0xE6, 0x00, 0x00, 0x00},
        // l (108)
        {0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00, 0x00, 0x00},
        // m (109)
        {0x00, 0x00, 0x00, 0xEC, 0xFE, 0xD6, 0xD6, 0xD6, 0xC6, 0x00, 0x00, 0x00},
        // n (110)
        {0x00, 0x00, 0x00, 0xDC, 0x66, 0x66, 0x66, 0x66, 0x66, 0x00, 0x00, 0x00},
        // o (111)
        {0x00, 0x00, 0x00, 0x7C, 0xC6, 0xC6, 0xC6, 0xC6, 0x7C, 0x00, 0x00, 0x00},
        // p (112)
        {0x00, 0x00, 0x00, 0xDC, 0x66, 0x66, 0x66, 0x7C, 0x60, 0x60, 0xF0, 0x00},
        // q (113)
        {0x00, 0x00, 0x00, 0x76, 0xCC, 0xCC, 0xCC, 0x7C, 0x0C, 0x0C, 0x1E, 0x00},
        // r (114)
        {0x00, 0x00, 0x00, 0xDC, 0x76, 0x66, 0x60, 0x60, 0xF0, 0x00, 0x00, 0x00},
        // s (115)
        {0x00, 0x00, 0x00, 0x7C, 0xC6, 0x70, 0x1C, 0xC6, 0x7C, 0x00, 0x00, 0x00},
        // t (116)
        {0x10, 0x30, 0x30, 0xFC, 0x30, 0x30, 0x30, 0x36, 0x1C, 0x00, 0x00, 0x00},
        // u (117)
        {0x00, 0x00, 0x00, 0xCC, 0xCC, 0xCC, 0xCC, 0xCC, 0x76, 0x00, 0x00, 0x00},
        // v (118)
        {0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00, 0x00, 0x00},
        // w (119)
        {0x00, 0x00, 0x00, 0xC6, 0xC6, 0xD6, 0xD6, 0xFE, 0x6C, 0x00, 0x00, 0x00},
        // x (120)
        {0x00, 0x00, 0x00, 0xC6, 0x6C, 0x38, 0x38, 0x6C, 0xC6, 0x00, 0x00, 0x00},
        // y (121)
        {0x00, 0x00, 0x00, 0xC6, 0xC6, 0xC6, 0xC6, 0x7E, 0x06, 0x0C, 0xF8, 0x00},
        // z (122)
        {0x00, 0x00, 0x00, 0xFE, 0xCC, 0x18, 0x30, 0x66, 0xFE, 0x00, 0x00, 0x00},
        // { (123)
        {0x0E, 0x18, 0x18, 0x18, 0x70, 0x18, 0x18, 0x18, 0x0E, 0x00, 0x00, 0x00},
        // | (124)
        {0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x18, 0x00, 0x00, 0x00},
        // } (125)
        {0x70, 0x18, 0x18, 0x18, 0x0E, 0x18, 0x18, 0x18, 0x70, 0x00, 0x00, 0x00},
        // ~ (126)
        {0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}
    };
    
    // Check if character is printable ASCII (32-126)
    if (c < 32 || c > 126) {
        c = '?'; // Use question mark for unknown characters
    }
    
    // Get font data for this character
    const unsigned char* charData = fontData[c - 32];
    
    // Compute pixel size separately for X and Y
    float pixelWidth  = scale / 960.0f;
    float pixelHeight = scale / 544.0f;

    // Draw the character pixel by pixel
    for (int row = 0; row < FONT_CHAR_HEIGHT; row++) {
        for (int col = 0; col < FONT_CHAR_WIDTH; col++) {
            if (charData[row] & (0x80 >> col)) {
                float pixelX = x + col * pixelWidth;
                float pixelY = y - row * pixelHeight;
                drawPixel(pixelX, pixelY, pixelWidth, pixelHeight);
            }
        }
    }
}

void BitmapFont::drawPixel(float x, float y, float width, float height) {
    glColor4f(color[0], color[1], color[2], color[3]);
    
    glBegin(GL_QUADS);
    glVertex2f(x, y);
    glVertex2f(x + width, y);
    glVertex2f(x + width, y - height);
    glVertex2f(x, y - height);
    glEnd();
}
